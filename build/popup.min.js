!function(){function a(){this.layer=document.querySelector(".overlay")}function b(){this.form=null,this.input=null,this.save=null,this.info=null,this.error=null,this.locked=!1,this.hidden=!0,a.call(this),this.initialize()}function c(a){this.tagWrapper=document.querySelector(".tag-wrapper"),this.tagInput=a,this.tagElement=document.createElement("span"),this.tagList={},this.isComposition=!1,this.initialize()}function d(a){this.form=a,this.registBtn=null,this.config=null,this.tagControl=null,this.initialize()}function e(a){this.form=a,this.add=null,this.category=null,this.registBtn=null,this.initialize()}function f(){this.form=null,this.category=null,this.save=null,this.error=null,this.hidden=!0,this.onAdded=null,a.call(this),this.initialize()}function g(b,c){this.message=b,this.isError=!!c,this.frame=null,this.loading=null,this.showLoading=!1,this.timer=null,a.call(this),this.initialize()}function h(){this.tabs={},this.contents={},this.activeTab=null,this.activeContent=null,this.initialize()}var i="/add",j="/add_rss";a.prototype.showOverlay=function(){this.layer.classList.remove("hidden")},a.prototype.hideOverlay=function(){this.layer.classList.add("hidden")};var k;b.getInstance=function(){return k||(k=new b),k},b.isHidden=function(){return b.getInstance().hidden},b.prototype=new a,b.prototype.initialize=function(){this.form=document.querySelector(".pb-settingform"),this.token=this.form.querySelector(".pb-tokeninput"),this.host=this.form.querySelector(".pb-hostinput"),this.save=this.form.querySelector(".pb-tokensave"),this.info=this.form.querySelector(".pb-tokeninfo"),this.tokenError=this.form.querySelector(".pb-tokenerror"),this.hostError=this.form.querySelector(".pb-hosterror"),this.save.addEventListener("click",this),this.info.querySelector("a").addEventListener("click",function(a){a.preventDefault(),chrome.tabs.create({url:HELP_PAGE_URL})})},b.prototype.setToken=function(a){this.host.value="requestHost"in a&&null!==a.requestHost?a.requestHost:"",this.token.value="token"in a&&null!==a.token?a.token:""},b.prototype.show=function(a){this.showOverlay(),this.form.classList.remove("hidden"),this.hostError.classList.add("hidden"),this.tokenError.classList.add("hidden"),this.locked=!!a,this.hidden=!1},b.prototype.hide=function(){this.hideOverlay(),this.form.classList.add("hidden"),this.hidden=!0},b.prototype.isLocked=function(){return this.locked},b.prototype.handleEvent=function(a){a.preventDefault();var b,c=this.token.value,d=this.host.value,e=[];return""===c&&e.push(function(){this.tokenError.textContent="Token must not empty!",this.tokenError.classList.remove("hidden")}.bind(this)),""===d?e.push(function(){this.hostError.textContent="Host must not empty!",this.hostError.classList.remove("hidden")}.bind(this)):/^https?:\/\/[\w\-\._]+(?:\:[0-9]+)?$/.test(d)||e.push(function(){this.hostError.textContent="Host must be URL format!",this.hostError.classList.remove("hidden")}.bind(this)),e.length>0?void e.forEach(function(a){a()}):(b=new Promise(this.acceptRequest(d,c)),void b.then(function(a){var b;this.tokenError.classList.add("hidden"),this.hostError.classList.add("hidden"),localStorage.setItem("pinboard-token",JSON.stringify({requestHost:d,token:c})),this.hide(),b=new g("Welcome, "+a.message+"!"),b.show(2e3)}.bind(this),function(a){this.hostError.textContent=a.host,this.hostError.classList.remove("hidden"),this.tokenError.textContent=a.token,this.tokenError.classList.remove("hidden")}.bind(this)))},b.prototype.acceptRequest=function(a,b){return function(c,d){var e=new XMLHttpRequest;e.onload=function(){200===e.status?c(JSON.parse(e.responseText)):d({host:"",token:"Token not authorized"})},e.onerror=function(){var a={host:"",token:""};404===e.status?a.host="Host not found":a.token="Token not authorized",d(a)},e.open("GET",a+"/accept",!0),e.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.setRequestHeader("X-LAP-Token",b),e.send(null)}},c.prototype.initialize=function(){var a=document.createElement("a");this.tagInput.addEventListener("compositionstart",this),this.tagInput.addEventListener("compositionend",this),this.tagInput.addEventListener("keyup",this),this.tagWrapper.addEventListener("click",this),this.tagElement.className="tag",a.className="remove",this.tagElement.appendChild(a)},c.prototype.handleEvent=function(a){switch(a.type){case"keyup":this.handleKeyUp(a);break;case"click":this.handleTagClick(a);break;case"compositionstart":this.isComposition=!0;break;case"compositionend":this.isComposition=!1}},c.prototype.handleKeyUp=function(a){if(32===a.keyCode&&this.isComposition!==!0){var b=this.tagInput.value;""===b||" "===b||this.checkExists(b)||this.createTag(b.trim()),this.tagInput.value="",this.tagInput.focus()}},c.prototype.handleTagClick=function(a){var b,c;a.target.matches(".remove")&&(b=a.target.parentNode,c=b.firstChild.nodeValue,b.parentNode.removeChild(b),c in this.tagList&&delete this.tagList[c])},c.prototype.createTag=function(a){var b=this.tagElement.cloneNode(!0);b.insertBefore(document.createTextNode(a),b.firstChild),this.tagWrapper.appendChild(b),this.tagList[a]=1},c.prototype.checkExists=function(a){return a in this.tagList},c.prototype.getTagList=function(){return Object.keys(this.tagList)},d.prototype.initialize=function(){this.registBtn=this.form.querySelector(".pb-submitbtn"),this.config=document.querySelector(".pb-configuration"),this.tagControl=new c(this.form.querySelector("[name=tags]")),this.registBtn.addEventListener("click",this),this.config.addEventListener("click",this)},d.prototype.handleEvent=function(a){switch(a.preventDefault(),a.currentTarget){case this.registBtn:this.sendPinData();break;case this.config:a.preventDefault(),this.toggleConfig()}},d.prototype.toggleConfig=function(){b.isHidden()?this.showConfiguration():this.hideConfiguration()},d.prototype.setUrl=function(a){this.form.querySelector("[name=url]").value=a},d.prototype.setTitle=function(a){this.form.querySelector("[name=title]").value=a},d.prototype.focus=function(a){this.form.querySelector("[name="+a+"]").focus()},d.prototype.showConfiguration=function(a){var c,d=b.getInstance(),e=localStorage.getItem("pinboard-token");try{c=JSON.parse(e),d.setToken(c),d.show(a)}catch(f){d.setToken({requestHost:"",token:""}),d.show(a)}},d.prototype.hideConfiguration=function(){var a=b.getInstance();a.isLocked()||a.hide()},d.prototype.sendPinData=function(){var a=this.form.querySelectorAll("input[type=text], textarea"),b=[],c=JSON.parse(localStorage.getItem("pinboard-token")),d=new XMLHttpRequest,e=new g("Sending pin data...");[].forEach.call(a,function(a){"tags"!==a.name&&b.push(encodeURIComponent(a.name)+"="+encodeURIComponent(a.value))}),this.tagControl.getTagList().forEach(function(a){b.push("tag="+encodeURIComponent(a))}),d.onload=function(){var a=200!==d.status?!0:!1;this.handleResponse(d.responseText,e,a)}.bind(this),d.onerror=function(){0===d.status?this.handleResponse("Server undefined. Does server start?",e,!0):this.handleResponse(d.responseText,e,!0)}.bind(this),e.setLoading(!0),e.show(),d.open("POST",c.requestHost+i,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.setRequestHeader("X-LAP-Token",c.token),d.send(b.join("&"))},d.prototype.parseMessage=function(a){var b;try{b=JSON.parse(a)}catch(c){console.log("JSON Parse error: %s",a),b={message:a}}return b},d.prototype.handleResponse=function(a,b,c){var d,e=this.parseMessage(a),f=new g(e.message,c),h=c?2e3:1600;b.hide(),f.show(h,!c),"categories"in e&&(d=JSON.parse(localStorage.getItem("pinboard-token")),d.categories=e.categories,localStorage.setItem(JSON.stringify(d)))},e.prototype.initialize=function(){this.registBtn=this.form.querySelector(".pb-submitbtn"),this.category=this.form.querySelector("[name=category]"),this.add=this.form.querySelector(".pb-add"),this.registBtn.addEventListener("click",this),this.add.addEventListener("click",this),this.refreshCategory()},e.prototype.refreshCategory=function(){try{for(var a=JSON.parse(localStorage.getItem("pinboard-token")),b=JSON.parse(a.categories)||[];this.category.firstChild;)this.category.removeChild(this.category.firstChild);b.forEach(function(a){var b=document.createElement("option");b.value=a.id,b.appendChild(document.createTextNode(a.name)),this.category.appendChild(b)}.bind(this))}catch(c){console.log(c.message)}},e.prototype.handleEvent=function(a){switch(a.preventDefault(),a.stopPropagation(),a.currentTarget){case this.registBtn:this.sendRssData();break;case this.add:this.addCategory()}},e.prototype.setUrl=function(a){this.form.querySelector("[name=url]").value=a},e.prototype.setTitle=function(a){this.form.querySelector("[name=title]").value=a},e.prototype.focus=function(a){this.form.querySelector("[name="+a+"]").focus()},e.prototype.addCategory=function(){var a=f.getInstance();a.show(),a.onAdded=this.refreshCategory.bind(this)},e.prototype.sendRssData=function(){var a=this.form.querySelectorAll("input[type=text], select"),b=[],c=JSON.parse(localStorage.getItem("pinboard-token")),d=new XMLHttpRequest,e=new g("Sending RSS data..."),f=[];return[].forEach.call(a,function(a){""===a.value&&f.push(function(){var b=document.createElement("span");b.classList.add("pb-inputerror"),b.appendChild(document.createTextNode(a.name+" must not be empty!")),a.parentNode.appendChild(b)}),b.push(encodeURIComponent(a.name)+"="+encodeURIComponent(a.value))}),f.length>0?void f.forEach(function(a){a()}):([].forEach.call(this.form.querySelectorAll(".pb-tokenerror"),function(a){a.parentNode.removeChild(a)}),d.onload=function(){var a=200!==d.status?!0:!1;this.handleResponse(d.responseText,e,a)}.bind(this),d.onerror=function(){0===d.status?this.handleResponse("Server undefined. Does server start?",e,!0):this.handleResponse(d.responseText,e,!0)}.bind(this),e.setLoading(!0),e.show(),d.open("POST",c.requestHost+j,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.setRequestHeader("X-LAP-Token",c.token),void d.send(b.join("&")))},e.prototype.parseMessage=function(a){var b;try{b=JSON.parse(a)}catch(c){console.log("JSON Parse error: %s",a),b={message:a}}return b},e.prototype.handleResponse=function(a,b,c){var d=this.parseMessage(a),e=new g(d.message,c),f=c?2e3:1600;b.hide(),e.show(f,!c),"categories"in d&&(setting=JSON.parse(localStorage.getItem("pinboard-token")),setting.categories=d.categories,localStorage.setItem(JSON.stringify(setting)))};var l;f.getInstance=function(){return l||(l=new f),l},f.isHidden=function(){return f.getInstance().hidden},f.prototype=new a,f.prototype.initialize=function(){this.form=document.querySelector(".category"),this.category=this.form.querySelector(".pb-categoryinput"),this.save=this.form.querySelector(".pb-categorysave"),this.close=this.form.querySelector(".pb-close"),this.categoryError=this.form.querySelector(".pb-categoryerror"),this.save.addEventListener("click",this),this.close.addEventListener("click",function(){this.hide()}.bind(this)),console.log(this)},f.prototype.show=function(){this.showOverlay(),this.form.classList.remove("hidden"),this.categoryError.classList.add("hidden"),this.category.focus(),this.hidden=!1},f.prototype.hide=function(){this.hideOverlay(),this.form.classList.add("hidden"),this.hidden=!0},f.prototype.handleEvent=function(a){a.preventDefault();var b,c=this.category.value,d=[];return""===c&&d.push(function(){this.categoryError.textContent="Category must not empty!",this.categoryError.classList.remove("hidden")}.bind(this)),d.length>0?void d.forEach(function(a){a()}):(b=new Promise(this.addRequest(c)),void b.then(function(a){var b,c;this.categoryError.classList.add("hidden"),c=JSON.parse(localStorage.getItem("pinboard-token")),c.categories=a.message,localStorage.setItem("pinboard-token",JSON.stringify(c)),this.onAdded&&this.onAdded(),this.hide(),b=new g("Category Added!"),b.show(1600)}.bind(this),function(a){this.categoryError.textContent=a.category,this.categoryError.classList.remove("hidden")}.bind(this)))},f.prototype.addRequest=function(a){return function(b,c){var d=new XMLHttpRequest;d.onload=function(){if(200===d.status)b(JSON.parse(d.responseText));else{var a=JSON.parse(d.responseText);c({category:-1!==a.message.indexOf("Duplicate entry")?"Category is duplicated!":a.message})}},d.onerror=function(){var a={category:""};a.category=404===d.status?"API Server not found":"Unexpected Error",c(a)};var e=JSON.parse(localStorage.getItem("pinboard-token"));d.open("POST",e.requestHost+"/add_rss_category",!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.setRequestHeader("X-LAP-Token",e.token),d.send("category="+encodeURIComponent(a))}},g.prototype=new a,g.prototype.initialize=function(){this.frame=document.querySelector(".pb-message"),this.loading=this.frame.querySelector("p"),this.loading.textContent=this.message},g.prototype.setLoading=function(a){this.showLoading=!!a},g.prototype.show=function(a,b){var c=this;this.showOverlay(),this.showLoading===!0?this.loading.classList.add("loading"):this.loading.classList.remove("loading"),this.isError===!0&&this.loading.classList.add("errormessage"),this.frame.classList.remove("hidden"),"number"==typeof a&&(this.timer=setTimeout(function(){c.hide(!!b)},a))},g.prototype.hide=function(a){this.hideOverlay(),this.frame.classList.add("hidden"),a===!0&&window.close()},h.ACTIVE_CLASS="active",h.HIDDEN_CLASS="hidden",h.prototype.initialize=function(){var a;[].forEach.call(document.querySelectorAll("[data-tab]"),function(b){var c=b.getAttribute("data-tab");b.classList.contains(h.ACTIVE_CLASS)&&(a=c,this.activeTab=b),this.tabs[c]=b,b.addEventListener("click",this)}.bind(this)),[].forEach.call(document.querySelectorAll("[data-tabcontent]"),function(b){var c=b.getAttribute("data-tabcontent");c===a&&(this.activeContent=b),this.contents[c]=b}.bind(this))},h.prototype.handleEvent=function(a){var b=a.target.getAttribute("data-tab");this.switchTab(b)},h.prototype.switchTab=function(a){a&&a in this.tabs&&(this.activeTab&&this.activeTab.classList.remove(h.ACTIVE_CLASS),this.activeContent&&this.activeContent.classList.add(h.HIDDEN_CLASS),this.activeTab=this.tabs[a],this.activeContent=this.contents[a],this.activeTab.classList.add(h.ACTIVE_CLASS),this.activeContent.classList.remove(h.HIDDEN_CLASS))},window.addEventListener("load",function(){{var a=document.getElementsByTagName("form"),c=new d(a[0]),f=new e(a[1]);new h}chrome.tabs.getSelected(null,function(a){c.setUrl(a.url),c.setTitle(a.title),localStorage.getItem("pinboard-token")?setTimeout(function(){c.focus("tags")},50):(c.showConfiguration(!0),chrome.tabs.executeScript(null,{file:"inject.js"},function(a){if(a[0]){var c=b.getInstance();c.setToken(a[0])}})),chrome.tabs.executeScript(null,{file:"inject_rss.js"},function(a){a[0]&&(f.setUrl(a[0].url),f.setTitle(a[0].title))})})})}();